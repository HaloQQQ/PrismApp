<UserControl
    x:Class="MusicPlayerModule.Views.LyricView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:MusicPlayerModule.Converters"
    xmlns:utils="clr-namespace:MusicPlayerModule.Utils"
    xmlns:viewmodels="clr-namespace:MusicPlayerModule.ViewModels"
    Background="{DynamicResource BackPanel.Background}">
    <UserControl.RenderTransform>
        <TranslateTransform Y="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=UserControl}}" />
    </UserControl.RenderTransform>

    <UserControl.Resources>
        <converters:DesktopLyricColorfulMultiConverter x:Key="DesktopLyricColorfulMultiConverter" />

        <converters:LyricWidth_MultiConverter x:Key="LyricWidth_MultiConverter" />

        <converters:MultiLyricHeightMultiConverter x:Key="MultiLyricHeightMultiConverter" />

        <LinearGradientBrush x:Key="GradientOpacityMask" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Offset="0" Color="Transparent" />
            <GradientStop Offset="0.15" Color="White" />
            <GradientStop Offset="0.85" Color="White" />
            <GradientStop Offset="1" Color="Transparent" />
        </LinearGradientBrush>

        <DataTemplate x:Key="ThreePrimaryColorModel" DataType="{x:Type viewmodels:ThreePrimaryColorModel}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding Name}" />
                <Slider
                    Width="100"
                    Height="3"
                    Maximum="255"
                    Style="{StaticResource Slider_ObviousThumb}"
                    TickFrequency="1"
                    Value="{Binding Value}" />
            </StackPanel>
        </DataTemplate>

        <Style
            x:Key="LyricListBoxItem"
            BasedOn="{StaticResource ListBoxItem_General}"
            TargetType="ListBoxItem">
            <Setter Property="FontSize" Value="20" />

            <Setter Property="Focusable" Value="False" />

            <Setter Property="RenderTransformOrigin" Value="0.5,0.5" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1.0" ScaleY="1.0" />
                </Setter.Value>
            </Setter>

            <Setter Property="ContentTemplate">
                <Setter.Value>
                    <DataTemplate DataType="{x:Type utils:KRCLyricsLine}">
                        <Grid HorizontalAlignment="Center">
                            <TextBlock
                                HorizontalAlignment="Left"
                                FontFamily="{Binding DataContext.DesktopLyric.CurrentFontModel.Family, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                FontSize="{Binding DataContext.DesktopLyric.CurrentLyricFontSize, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                Text="{Binding Words}"
                                TextWrapping="NoWrap" />

                            <TextBlock
                                HorizontalAlignment="Left"
                                ClipToBounds="True"
                                FontFamily="{Binding DataContext.DesktopLyric.CurrentFontModel.Family, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                FontSize="{Binding DataContext.DesktopLyric.CurrentLyricFontSize, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                Foreground="{Binding DataContext.DesktopLyric.CurrentLyricForeground.ColorBrush, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                Text="{Binding Words}"
                                TextTrimming="None"
                                TextWrapping="NoWrap">

                                <TextBlock.Width>
                                    <MultiBinding Converter="{StaticResource LyricWidth_MultiConverter}" FallbackValue="0">
                                        <Binding Mode="OneWay" Path="IsPlayingLine" />
                                        <Binding
                                            Mode="OneWay"
                                            Path="DataContext.CurrentMedia.WordProgress"
                                            RelativeSource="{RelativeSource AncestorType=ListBox}" />

                                        <Binding Mode="OneWay" RelativeSource="{RelativeSource Self}" />
                                    </MultiBinding>
                                </TextBlock.Width>

                                <TextBlock.ToolTip>
                                    <TextBlock>
                                        <TextBlock Text="{Binding LineStart.TotalSeconds}" />
                                        <TextBlock Text="{Binding LineDuring.TotalSeconds}" />
                                    </TextBlock>
                                </TextBlock.ToolTip>
                            </TextBlock>
                        </Grid>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="PanelSimpleLyric">
            <Grid Margin="20,10" HorizontalAlignment="Center">
                <TextBlock
                    FontSize="{Binding DataContext.DesktopLyric.CurrentLyricFontSize, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource DigitMultiConverter}, ConverterParameter=1.5, FallbackValue=20}"
                    Foreground="{DynamicResource TextBlock.Foreground}"
                    Text="{Binding Words}" />

                <TextBlock
                    HorizontalAlignment="Left"
                    ClipToBounds="True"
                    FontSize="{Binding DataContext.DesktopLyric.CurrentLyricFontSize, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource DigitMultiConverter}, ConverterParameter=1.5, FallbackValue=20}"
                    Foreground="{Binding DataContext.DesktopLyric.CurrentLyricForeground.ColorBrush, RelativeSource={RelativeSource AncestorType=UserControl}, FallbackValue=SkyBlue}"
                    Text="{Binding Words}"
                    TextTrimming="None">
                    <TextBlock.Width>
                        <MultiBinding Converter="{StaticResource DesktopLyricColorfulMultiConverter}">
                            <Binding Mode="OneWay" Path="IsPlayed" />

                            <Binding Mode="OneWay" Path="IsPlayingLine" />

                            <Binding
                                Mode="OneWay"
                                Path="DataContext.CurrentMedia.WordProgress"
                                RelativeSource="{RelativeSource AncestorType=Border}" />

                            <Binding Mode="OneWay" RelativeSource="{RelativeSource Self}" />
                        </MultiBinding>
                    </TextBlock.Width>
                    <TextBlock.ToolTip>
                        <TextBlock>
                            <TextBlock Text="{Binding LineStart.TotalSeconds}" />
                            <TextBlock Text="{Binding LineDuring.TotalSeconds}" />
                        </TextBlock>
                    </TextBlock.ToolTip>
                </TextBlock>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <Border CommandManager.Executed="UserControl_Executed">
        <Border.InputBindings>
            <MouseBinding Command="{x:Static MediaCommands.TogglePlayPause}" MouseAction="LeftClick" />
        </Border.InputBindings>
        <DockPanel>
            <DockPanel
                Margin="20,5"
                HorizontalAlignment="Stretch"
                DockPanel.Dock="Top">
                <Button
                    Command="{x:Static NavigationCommands.GoToPage}"
                    Content="&#xe65e;"
                    DockPanel.Dock="Left"
                    Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}" />

                <ToggleButton
                    x:Name="LyricSettingButton"
                    Content="&#xe8b8;"
                    DockPanel.Dock="Right"
                    FontSize="20"
                    Style="{StaticResource ButtonBase_Icon_ScaleDown_Big}" />
                <Popup
                    IsOpen="{Binding IsChecked, ElementName=LyricSettingButton}"
                    MouseLeftButtonDown="EmptyHandler"
                    Placement="Left"
                    PlacementTarget="{Binding ElementName=LyricSettingButton}">
                    <Border
                        Width="320"
                        Padding="20"
                        Background="{StaticResource PopupBackground}"
                        CornerRadius="10">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="20"
                                    Style="{StaticResource TextBlock_Theme}"
                                    Text="大小：" />
                                <StackPanel VerticalAlignment="Center">
                                    <Slider
                                        x:Name="LyricFontSizeSlider"
                                        Width="200"
                                        Height="3"
                                        Margin="5"
                                        HorizontalAlignment="Left"
                                        Maximum="30"
                                        Minimum="15"
                                        Style="{StaticResource Slider_ObviousThumb}"
                                        TickFrequency="5"
                                        Value="{Binding DesktopLyric.CurrentLyricFontSize}" />

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock
                                            Margin="-2,0,0,0"
                                            Style="{StaticResource TextBlock_Theme}"
                                            Text="15" />
                                        <TextBlock
                                            Margin="46,0,0,0"
                                            Style="{StaticResource TextBlock_Theme}"
                                            Text="20" />
                                        <TextBlock
                                            Margin="48,0,0,0"
                                            Style="{StaticResource TextBlock_Theme}"
                                            Text="25" />
                                        <TextBlock
                                            Margin="46,0,0,0"
                                            Style="{StaticResource TextBlock_Theme}"
                                            Text="30" />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock
                                    FontSize="20"
                                    Style="{StaticResource TextBlock_Theme}"
                                    Text="颜色：" />

                                <StackPanel>
                                    <ListBox
                                        x:Name="LyricForegroundListBox"
                                        Margin="5,0"
                                        ItemsSource="{Binding DesktopLyric.DefaultLyricForegrounds}"
                                        SelectedItem="{Binding DesktopLyric.CurrentLyricForeground}">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel MaxWidth="220" />
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                        <ListBox.ItemContainerStyle>
                                            <Style BasedOn="{StaticResource ListBoxItem_General}" TargetType="ListBoxItem">
                                                <Setter Property="BorderBrush" Value="Transparent" />
                                                <Setter Property="Background" Value="{Binding ColorBrush}" />
                                                <Setter Property="BorderThickness" Value="2" />
                                                <Setter Property="ToolTip" Value="{Binding ColorBrush.Color}" />

                                                <EventSetter Event="MouseMove" Handler="DragLeaveFrom" />

                                                <Setter Property="IsSelected" Value="{Binding Selected}" />

                                                <Setter Property="Width" Value="40" />
                                                <Setter Property="Height" Value="40" />

                                                <Setter Property="MyAttachProperty.CornerRadius" Value="20" />
                                                <Setter Property="Content" Value="{x:Null}" />

                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Selected}" Value="True">
                                                        <Setter Property="BorderBrush" Value="{StaticResource HoveredTransparentButtonBackground}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ListBox.ItemContainerStyle>
                                    </ListBox>

                                    <StackPanel Orientation="Horizontal">
                                        <ListBox
                                            ItemContainerStyle="{StaticResource ListBoxItem_General}"
                                            ItemTemplate="{StaticResource ThreePrimaryColorModel}"
                                            ItemsSource="{Binding DesktopLyric.LyricColorBrush.Colors}" />

                                        <Button
                                            x:Name="ForegroundColor"
                                            Width="40"
                                            Height="40"
                                            AllowDrop="True"
                                            Background="{Binding DesktopLyric.LyricColorBrush.ColorBrush, Mode=TwoWay}"
                                            Command="{Binding DesktopLyric.SelectLyricColorCommand}"
                                            Drop="DropIn_ForegroundColor"
                                            ToolTip="{Binding DesktopLyric.LyricColorBrush.ColorBrush.Color}">
                                            <Button.Style>
                                                <Style BasedOn="{StaticResource {x:Type Button}}" TargetType="Button">
                                                    <Setter Property="MinWidth" Value="0" />
                                                    <Setter Property="MinHeight" Value="0" />

                                                    <Setter Property="MyAttachProperty.CornerRadius" Value="20" />

                                                    <Setter Property="BorderThickness" Value="2" />
                                                    <Setter Property="BorderBrush" Value="Transparent" />

                                                    <Setter Property="Effect" Value="{x:Null}" />

                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DesktopLyric.LyricColorBrush.IsSelected}" Value="True">
                                                            <Setter Property="BorderBrush" Value="{StaticResource HoveredTransparentButtonBackground}" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Margin="0,10" Orientation="Horizontal">
                                <TextBlock
                                    FontSize="20"
                                    Style="{StaticResource TextBlock_Theme}"
                                    Text="渐变：" />

                                <ListBox
                                    ItemContainerStyle="{StaticResource ListBoxItem_General}"
                                    ItemTemplate="{StaticResource ThreePrimaryColorModel}"
                                    ItemsSource="{Binding DesktopLyric.LinearGradientColorBrush.Colors}" />

                                <Border
                                    x:Name="LinearGradientStartColor"
                                    Width="40"
                                    Height="40"
                                    AllowDrop="True"
                                    Background="{Binding DesktopLyric.LinearGradientColorBrush.ColorBrush, Mode=TwoWay}"
                                    CornerRadius="20"
                                    Drop="DropIn_LinearGradientForegroundColor"
                                    ToolTip="{Binding DesktopLyric.LinearGradientColorBrush.ColorBrush.Color}" />

                                <Button
                                    MinWidth="0"
                                    Padding="10"
                                    Command="{Binding DesktopLyric.LinearGradientColorBrush.ResetColorCommand}"
                                    Content="重置"
                                    FontSize="14"
                                    MyAttachProperty.CornerRadius="10"
                                    Style="{StaticResource ButtonBase_Icon_Conent_Transparent}" />
                            </StackPanel>

                            <WrapPanel>
                                <TextBlock
                                    FontSize="20"
                                    Style="{StaticResource TextBlock_Theme}"
                                    Text="字体：" />
                                <ListBox
                                    ItemsSource="{Binding DesktopLyric.Fonts}"
                                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                    SelectedItem="{Binding DesktopLyric.CurrentFontModel}">
                                    <ListBox.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel />
                                        </ItemsPanelTemplate>
                                    </ListBox.ItemsPanel>
                                    <ListBox.ItemContainerStyle>
                                        <Style BasedOn="{StaticResource {x:Type ListBoxItem}}" TargetType="ListBoxItem">
                                            <Setter Property="MyAttachProperty.CornerRadius" Value="10" />
                                            <Style.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter Property="Background" Value="{StaticResource TransparentButtonBackground}" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ListBox.ItemContainerStyle>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate DataType="viewmodels:FontModel">
                                            <TextBlock
                                                MinWidth="60"
                                                Padding="10,5"
                                                FontFamily="{Binding Family}"
                                                FontSize="14"
                                                Text="{Binding DisplayName}"
                                                TextAlignment="Center"
                                                TextWrapping="Wrap" />
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </WrapPanel>
                        </StackPanel>
                    </Border>
                </Popup>
            </DockPanel>

            <DockPanel Height="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource DigitMultiConverter}, ConverterParameter=0.8}" VerticalAlignment="Top">

                <TextBlock
                    HorizontalAlignment="Center"
                    DockPanel.Dock="Top"
                    FontFamily="{Binding DesktopLyric.CurrentFontModel.Family}"
                    FontSize="21"
                    FontWeight="Bold"
                    Foreground="{Binding DesktopLyric.CurrentLyricForeground.ColorBrush, FallbackValue=SkyBlue}"
                    Text="{Binding CurrentMedia.Music.Name}" />

                <TextBlock
                    Margin="0,10"
                    HorizontalAlignment="Center"
                    DockPanel.Dock="Top"
                    FontFamily="{Binding DesktopLyric.CurrentFontModel.Family}"
                    Foreground="{Binding DesktopLyric.CurrentLyricForeground.ColorBrush, FallbackValue=SkyBlue}"
                    Text="{Binding CurrentMedia.Music.Singer}" />

                <StackPanel
                    x:Name="LyricSimple"
                    Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=DockPanel}}"
                    Margin="0,30,0,0"
                    VerticalAlignment="Bottom"
                    Visibility="Collapsed">
                    <ContentControl
                        HorizontalAlignment="Left"
                        Content="{Binding CurrentMedia.OneLine}"
                        ContentTemplate="{StaticResource PanelSimpleLyric}"
                        FontFamily="{Binding DesktopLyric.CurrentFontModel.Family}"
                        FontSize="30" />

                    <ContentControl
                        HorizontalAlignment="Right"
                        Content="{Binding CurrentMedia.AnotherLine}"
                        ContentTemplate="{StaticResource PanelSimpleLyric}"
                        FontFamily="{Binding DesktopLyric.CurrentFontModel.Family}"
                        FontSize="30" />
                </StackPanel>

                <ListBox
                    x:Name="LyricList"
                    DockPanel.Dock="Top"
                    Focusable="False"
                    ItemsSource="{Binding CurrentMedia.Music.Lyric.Lines}"
                    OpacityMask="{StaticResource GradientOpacityMask}"
                    ScrollViewer.VerticalScrollBarVisibility="Disabled"
                    SelectionChanged="LyricList_SelectionChanged">
                    <ListBox.ItemContainerStyle>
                        <Style BasedOn="{StaticResource LyricListBoxItem}" TargetType="ListBoxItem">
                            <EventSetter Event="MouseDoubleClick" Handler="ListBoxItem_MouseDoubleClick" />
                            <EventSetter Event="PreviewMouseRightButtonDown" Handler="SwitchLyricMode" />

                            <Setter Property="Padding" Value="0,10" />

                            <Setter Property="Width" Value="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=DockPanel}}" />

                            <Setter Property="IsSelected" Value="{Binding IsPlayingLine, Mode=OneWay}" />

                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPlayingLine}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation
                                                    DecelerationRatio="0.5"
                                                    Storyboard.TargetProperty="(ListBoxItem.RenderTransform).(ScaleTransform.ScaleX)"
                                                    To="1.5"
                                                    Duration="0:0:0.5" />
                                                <DoubleAnimation
                                                    DecelerationRatio="0.5"
                                                    Storyboard.TargetProperty="(ListBoxItem.RenderTransform).(ScaleTransform.ScaleY)"
                                                    To="1.5"
                                                    Duration="0:0:0.5" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation
                                                    DecelerationRatio="0.5"
                                                    Storyboard.TargetProperty="(ListBoxItem.RenderTransform).(ScaleTransform.ScaleX)"
                                                    To="1.0"
                                                    Duration="0:0:0.5" />
                                                <DoubleAnimation
                                                    DecelerationRatio="0.5"
                                                    Storyboard.TargetProperty="(ListBoxItem.RenderTransform).(ScaleTransform.ScaleY)"
                                                    To="1.0"
                                                    Duration="0:0:0.5" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </DockPanel>
        </DockPanel>

    </Border>
</UserControl>
