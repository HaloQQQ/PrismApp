<UserControl
    x:Class="MusicPlayerModule.Views.MusicFooterView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:contracts="clr-namespace:MusicPlayerModule.Contracts"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:prism="http://prismlibrary.com/"
    prism:ViewModelLocator.AutoWireViewModel="True">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/MusicPlayerModule;component/Resources/MediaDic.xaml" />

                <ResourceDictionary Source="/MusicPlayerModule;component/Resources/MusicFooterDic.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid
        Background="#20000000"
        CommandManager.Executed="UserControl_Executed"
        Cursor="Arrow"
        MouseWheel="Grid_MouseWheel">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition />
        </Grid.RowDefinitions>

        <MediaElement
            x:Name="mediaPlayer"
            Grid.Row="0"
            Source="{Binding CurrentMedia.Music.FilePath}" />

        <Viewbox Grid.Row="0">
            <Grid Height="16">
                <Slider
                    x:Name="musicSlider"
                    Maximum="{Binding CurrentMedia.TotalMills}"
                    Style="{StaticResource MediaProgressSlider}"
                    ValueChanged="musicSlider_ValueChanged"
                    Value="{Binding CurrentMedia.CurrentMills}" />

                <TextBlock Text="A" ToolTip="{Binding CurrentMedia.PointATime}">
                    <TextBlock.Style>
                        <Style BasedOn="{StaticResource Music_PointABTextBlock}" TargetType="TextBlock">
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding CurrentMedia.PointAMills}" Value="0" />
                                        <Condition Binding="{Binding CurrentMedia.PointBMills}" Value="0" />
                                    </MultiDataTrigger.Conditions>

                                    <Setter Property="Visibility" Value="Hidden" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                    <TextBlock.RenderTransform>
                        <TranslateTransform>
                            <TranslateTransform.X>
                                <MultiBinding Converter="{StaticResource MultiConverter_MultiplicationDivision}">
                                    <Binding Mode="OneWay" Path="CurrentMedia.PointAMills" />
                                    <Binding
                                        ElementName="musicSlider"
                                        Mode="OneWay"
                                        Path="Width" />
                                    <Binding Mode="OneWay" Path="CurrentMedia.TotalMills" />
                                </MultiBinding>
                            </TranslateTransform.X>
                        </TranslateTransform>
                    </TextBlock.RenderTransform>
                </TextBlock>

                <TextBlock Text="B" ToolTip="{Binding CurrentMedia.PointBTime}">
                    <TextBlock.Style>
                        <Style BasedOn="{StaticResource Music_PointABTextBlock}" TargetType="TextBlock">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding CurrentMedia.PointBMills}" Value="0">
                                    <Setter Property="Visibility" Value="Hidden" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                    <TextBlock.RenderTransform>
                        <TranslateTransform>
                            <TranslateTransform.X>
                                <MultiBinding Converter="{StaticResource MultiConverter_MultiplicationDivision}">
                                    <Binding Mode="OneWay" Path="CurrentMedia.PointBMills" />
                                    <Binding
                                        ElementName="musicSlider"
                                        Mode="OneWay"
                                        Path="Width" />
                                    <Binding Mode="OneWay" Path="CurrentMedia.TotalMills" />
                                </MultiBinding>
                            </TranslateTransform.X>
                        </TranslateTransform>
                    </TextBlock.RenderTransform>
                </TextBlock>
            </Grid>
        </Viewbox>

        <Grid Grid.Row="1" Background="Transparent">
            <Grid.InputBindings>
                <MouseBinding Command="GoToPage" MouseAction="LeftClick" />
            </Grid.InputBindings>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="3*" />
            </Grid.ColumnDefinitions>

            <Viewbox
                Grid.Column="0"
                HorizontalAlignment="Left"
                Style="{StaticResource OnlyDownViewbox}">
                <StackPanel
                    Grid.Column="0"
                    HorizontalAlignment="Left"
                    Orientation="Horizontal">
                    <Image Style="{StaticResource MusicImage}" />

                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top">
                            <TextBlock
                                MaxWidth="250"
                                Style="{StaticResource TextBlock_Theme}"
                                Text="{Binding CurrentMedia.Music.Name}"
                                ToolTip="{Binding CurrentMedia.Music.Name}" />
                            <TextBlock
                                MaxWidth="250"
                                Style="{StaticResource TextBlock_Theme}"
                                Text="{Binding CurrentMedia.Music.Singer}"
                                ToolTip="{Binding CurrentMedia.Music.Singer}" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <ToggleButton Style="{StaticResource Love}" />
                            <Button
                                Content="&#xe63b;"
                                Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                                ToolTip="下载" />
                            <Button
                                Content="&#xe891;"
                                Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                                ToolTip="评论" />
                            <Button
                                Content="&#xe608;"
                                Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                                ToolTip="分享" />
                            <Button
                                Content="&#xe682;"
                                Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                                ToolTip="更多" />
                        </StackPanel>
                    </DockPanel>
                </StackPanel>
            </Viewbox>

            <Viewbox Grid.Column="1" Style="{StaticResource OnlyDownViewbox}">
                <StackPanel
                    Grid.Column="1"
                    HorizontalAlignment="Center"
                    Orientation="Horizontal">
                    <Button Command="{Binding RewindCommand}" Style="{StaticResource Button_Icon_Rewind_1s}" />

                    <Button
                        Command="{Binding PrevCommand}"
                        CommandParameter="{Binding CurrentMedia}"
                        Style="{StaticResource Button_Icon_Prev}" />

                    <ToggleButton
                        Command="{Binding TogglePlayCommand}"
                        CommandParameter="{Binding CurrentMedia}"
                        IsChecked="{Binding Running, Mode=OneWay}"
                        Style="{StaticResource ToggleButton_Icon_Play}" />

                    <Button
                        Command="{Binding NextCommand}"
                        CommandParameter="{Binding CurrentMedia}"
                        Style="{StaticResource Button_Icon_Next}" />

                    <Button Command="{Binding FastForwardCommand}" Style="{StaticResource Button_Icon_FastForward_1s}" />

                    <Button Command="{Binding StopPlayCommand}" Style="{StaticResource Button_Icon_Stop}" />
                </StackPanel>
            </Viewbox>

            <Viewbox
                Grid.Column="2"
                HorizontalAlignment="Right"
                Style="{StaticResource OnlyDownViewbox}">
                <StackPanel
                    Grid.Column="2"
                    Margin="10,5"
                    HorizontalAlignment="Right"
                    Orientation="Horizontal">
                    <Grid
                        x:Name="MusicSpeedRatioPanel"
                        Margin="5,0"
                        Background="Transparent">
                        <TextBlock
                            HorizontalAlignment="Center"
                            Style="{StaticResource TextBlock_NotImportant_Black}"
                            Visibility="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Grid}, Converter={StaticResource BoolToCollapsedVisibleConverter}}">
                            <TextBlock Text="{Binding CurrentMedia.CurrentTime, FallbackValue=00:00}" />
                            /
                            <TextBlock Text="{Binding CurrentMedia.Music.Duration, FallbackValue=00:00}" />
                        </TextBlock>

                        <StackPanel Orientation="Horizontal" Visibility="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Grid}, Converter={StaticResource BoolToVisibleHiddenConverter}}">
                            <ToggleButton
                                x:Name="MusicSpeedToggleButton"
                                Content="倍速"
                                Style="{StaticResource MusicEffectToggleButton}" />
                            <Popup
                                Width="280"
                                Height="110"
                                HorizontalOffset="-115"
                                MouseLeftButtonDown="EmptyHandler"
                                MyAttachProperty.IsAppearOnHovered="True"
                                Placement="Top"
                                PlacementTarget="{Binding ElementName=MusicSpeedToggleButton}"
                                VerticalOffset="7">
                                <Border
                                    Padding="10,15"
                                    Background="{StaticResource PopupBackground}"
                                    Clip="{StaticResource PopupGeometryGroup_MediaSpeedRatio}">
                                    <StackPanel>
                                        <TextBlock
                                            VerticalAlignment="Top"
                                            FontSize="16"
                                            Foreground="{StaticResource LightWhite}"
                                            TextAlignment="Center">
                                            <TextBlock Text="{Binding Value, ElementName=MusicSpeedRatioSlider}" />
                                            倍速播放
                                        </TextBlock>

                                        <Slider
                                            x:Name="MusicSpeedRatioSlider"
                                            Width="260"
                                            Height="3"
                                            Margin="0,10"
                                            VerticalAlignment="Center"
                                            Maximum="1.5"
                                            Minimum="0.5"
                                            TickFrequency="0.1"
                                            ValueChanged="MusicSpeedRatioSlider_ValueChanged"
                                            Value="1" />

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <TextBlock
                                                Grid.Column="0"
                                                FontSize="16"
                                                Foreground="{StaticResource LightWhite}"
                                                Text="减慢" />
                                            <TextBlock
                                                Grid.Column="1"
                                                FontSize="16"
                                                Foreground="{StaticResource LightWhite}"
                                                Text="正常"
                                                TextAlignment="Center" />
                                            <TextBlock
                                                Grid.Column="2"
                                                FontSize="16"
                                                Foreground="{StaticResource LightWhite}"
                                                Text="加快" />
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </Popup>
                            <ToggleButton Content="音质" Style="{StaticResource MusicEffectToggleButton}" />
                            <ToggleButton Content="音效" Style="{StaticResource MusicEffectToggleButton}" />
                        </StackPanel>
                    </Grid>

                    <ToggleButton
                        x:Name="VolumeToggleButton"
                        Click="VolumeToggleButton_Click"
                        IsChecked="{Binding IsMuted, ElementName=mediaPlayer, Mode=TwoWay}"
                        Style="{StaticResource ToggleButton_Icon_Volume}" />
                    <Popup
                        x:Name="VolumePopup"
                        Width="65"
                        Height="202"
                        HorizontalOffset="-23"
                        MouseLeftButtonDown="EmptyHandler"
                        MyAttachProperty.IsAppearOnHovered="True"
                        Placement="Top"
                        PlacementTarget="{Binding ElementName=VolumeToggleButton}"
                        VerticalOffset="5">
                        <!--  音量调节模态框  -->
                        <StackPanel Background="{StaticResource PopupBackground}" Clip="{StaticResource PopupGeometryGroup_Volume}">
                            <Slider
                                Width="4"
                                Height="130"
                                Margin="10,25,10,10"
                                Maximum="100"
                                Minimum="0"
                                Orientation="Vertical"
                                Style="{StaticResource Slider_ObviousThumb}"
                                ValueChanged="Slider_ValueChanged"
                                Value="{Binding Volume, ElementName=mediaPlayer, Converter={StaticResource DigitMultiConverter}, ConverterParameter=100}" />

                            <TextBlock HorizontalAlignment="Center" Style="{StaticResource TextBlock_NotImportant_White}">
                                <TextBlock Text="{Binding Volume, ElementName=mediaPlayer, Converter={StaticResource DigitMultiConverter}, ConverterParameter=100, Mode=OneWay}" />
                                %
                            </TextBlock>
                        </StackPanel>
                    </Popup>

                    <ToggleButton x:Name="listButton" IsChecked="{Binding IsEditingPlayOrder}">
                        <ToggleButton.Style>
                            <Style BasedOn="{StaticResource ButtonBase_Icon_Small_HoverBlue}" TargetType="ToggleButton">
                                <Setter Property="Margin" Value="2,0" />

                                <Setter Property="Content" Value="{Binding SelectedItem.IconString, ElementName=PlayOrderList, FallbackValue=播放顺序}" />
                                <Setter Property="ToolTip" Value="{Binding SelectedItem.Description, ElementName=PlayOrderList}" />
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>
                    <Popup
                        HorizontalOffset="-67"
                        MouseLeftButtonDown="EmptyHandler"
                        MyAttachProperty.IsAppearOnHovered="True"
                        Placement="Top"
                        PlacementTarget="{Binding ElementName=listButton}"
                        VerticalOffset="10">
                        <Border
                            Height="310"
                            Background="{StaticResource PopupBackground}"
                            Clip="{StaticResource PopupGeometryGroup_PlayOrder}">
                            <ListBox
                                x:Name="PlayOrderList"
                                ItemsSource="{x:Static contracts:CustomStatics.MediaPlayOrderList}"
                                SelectedItem="{Binding CurrentPlayOrder}">
                                <ListBox.ItemContainerStyle>
                                    <Style BasedOn="{StaticResource {x:Type ListBoxItem}}" TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="0,10" />

                                        <Setter Property="ContentTemplate">
                                            <Setter.Value>
                                                <DataTemplate DataType="contracts:MediaPlayOrderModel">
                                                    <TextBlock Margin="30,10" Style="{StaticResource TextBlock_Theme_Icon_MouseOver}">
                                                        <TextBlock Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Text="{Binding IconString}" />
                                                        <TextBlock Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Text="{Binding Description}" />
                                                    </TextBlock>
                                                </DataTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListBox.ItemContainerStyle>

                                <ListBox.Style>
                                    <Style BasedOn="{StaticResource {x:Type ListBox}}" TargetType="ListBox">

                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding CurrentPlayOrder}" Value="{x:Null}">
                                                <Setter Property="SelectedIndex" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListBox.Style>
                            </ListBox>
                        </Border>
                    </Popup>

                    <Button
                        Content="&#xe607;"
                        Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                        ToolTip="一起听" />

                    <ToggleButton
                        Command="{Binding ToggleDesktopLyricCommand}"
                        Content="&#xe671;"
                        IsChecked="{Binding DesktopLyric.IsDesktopLyricShow, Mode=OneWay}"
                        ToolTip="{Binding KeyGestureDic[桌面歌词].ToolTip}">
                        <ToggleButton.Style>
                            <Style BasedOn="{StaticResource ToggleButton_Icon_Fill}" TargetType="ToggleButton">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DisplayPlaying.Count}" Value="0">
                                        <Setter Property="IsEnabled" Value="False" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>

                    <ToggleButton x:Name="PlayingListButton" ToolTip="{Binding KeyGestureDic[播放列表].ToolTip}">
                        <ToggleButton.Style>
                            <Style BasedOn="{StaticResource ButtonBase_Icon_Small_HoverBlue}" TargetType="ToggleButton">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DisplayPlaying.Count}" Value="0">
                                        <Setter Property="IsEnabled" Value="False" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                        <TextBlock>
                            <TextBlock Text="&#xea6f;" />
                            <TextBlock Width="30" Text="{Binding DisplayPlaying.Count}" />
                        </TextBlock>
                    </ToggleButton>
                    <Popup
                        x:Name="PlayingListPopup"
                        Width="400"
                        Height="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource DigitMultiConverter}, ConverterParameter=0.8}"
                        Closed="PlayingListPopup_Closed"
                        HorizontalOffset="-343"
                        IsOpen="{Binding IsChecked, ElementName=PlayingListButton}"
                        MouseLeftButtonDown="EmptyHandler"
                        Opened="PlayingListPopup_UpdateDataGridScrollBar"
                        Placement="Top"
                        PlacementTarget="{Binding ElementName=PlayingListButton}"
                        PopupAnimation="Fade"
                        VerticalOffset="-18">
                        <Popup.InputBindings>
                            <KeyBinding
                                Key="{Binding KeyGestureDic[搜索].SelectedKey}"
                                Command="Find"
                                CommandParameter="Playing"
                                CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=Popup}}"
                                Modifiers="{Binding KeyGestureDic[搜索].ModifierKey}" />

                            <KeyBinding
                                Key="Esc"
                                Command="Close"
                                CommandParameter="StopPlayingListFilte"
                                CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=Popup}}" />
                        </Popup.InputBindings>
                        <Border Background="{StaticResource PopupBackground}" CornerRadius="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <DockPanel
                                    Grid.Row="0"
                                    Margin="20,20,20,0"
                                    LastChildFill="False">
                                    <DockPanel DockPanel.Dock="Top">
                                        <TextBlock
                                            HorizontalAlignment="Left"
                                            DockPanel.Dock="Left"
                                            Foreground="{StaticResource LightWhite}">
                                            共
                                            <TextBlock Text="{Binding DisplayPlaying.Count}" />
                                            首
                                        </TextBlock>

                                        <WrapPanel HorizontalAlignment="Right" DockPanel.Dock="Right">
                                            <ToggleButton
                                                x:Name="QueryButton"
                                                Content="&#xe632;"
                                                Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                                                ToolTip="搜索" />

                                            <Button
                                                Command="{Binding CleanPlayingCommand}"
                                                Content="&#xec7b;"
                                                Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}"
                                                ToolTip="{Binding KeyGestureDic[清空播放队列].ToolTip}" />
                                        </WrapPanel>
                                    </DockPanel>

                                    <StackPanel
                                        DockPanel.Dock="Bottom"
                                        Orientation="Horizontal"
                                        Visibility="{Binding IsChecked, ElementName=QueryButton, Mode=OneWay, Converter={StaticResource BoolToVisibleCollapsedConverter}}">
                                        <TextBox
                                            x:Name="PlayingKeyWordsTxt"
                                            Width="310"
                                            Margin="0,5,5,5"
                                            Padding="10,0,0,0"
                                            Background="Transparent"
                                            BorderBrush="{StaticResource LightWhite}"
                                            BorderThickness="1"
                                            Focusable="True"
                                            IsVisibleChanged="PlayingListFilterPanel_IsVisibleChanged"
                                            MyAttachProperty.CornerRadius="15"
                                            MyAttachProperty.PlaceHolder="请输入关键字"
                                            Text="{Binding PlayingListFilteKeyWords, UpdateSourceTrigger=PropertyChanged, Delay=100}" />
                                        <Button
                                            Command="Close"
                                            CommandParameter="StopPlayingListFilte"
                                            Content="消失"
                                            Foreground="{StaticResource LightWhite}"
                                            Style="{StaticResource ButtonBase_Icon_Small_HoverBlue}" />
                                    </StackPanel>
                                </DockPanel>

                                <DataGrid
                                    x:Name="PlayingDataGrid"
                                    Grid.Row="1"
                                    ContextMenu="{StaticResource PlayinigDataGridContextMenu}"
                                    FontSize="14"
                                    HeadersVisibility="Row"
                                    ItemsSource="{Binding DisplayPlaying}"
                                    SelectedItem="{Binding CurrentMedia, Mode=OneWay}"
                                    Style="{StaticResource DataGrid_Transparent}">
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="MouseDoubleClick">
                                            <i:InvokeCommandAction Command="{Binding DataContext.TogglePlayCurrentCommand, RelativeSource={RelativeSource AncestorType=Grid}}" CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=DataGrid}}" />
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                    <DataGrid.CellStyle>
                                        <Style BasedOn="{StaticResource DataGridCell_General}" TargetType="DataGridCell">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding DataContext.IsPlayingMedia, RelativeSource={RelativeSource AncestorType=DataGridRow}}" Value="True">
                                                    <Setter Property="Foreground" Value="{StaticResource SkyBlue}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGrid.CellStyle>

                                    <DataGrid.RowStyle>
                                        <Style BasedOn="{StaticResource {x:Type DataGridRow}}" TargetType="DataGridRow">
                                            <Setter Property="Header" Value="{Binding IndexString, Mode=OneWay}" />
                                        </Style>
                                    </DataGrid.RowStyle>

                                    <DataGrid.Columns>
                                        <DataGridTemplateColumn MinWidth="30">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <ToggleButton Style="{StaticResource Love}" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <DataGridTemplateColumn Width="300" CellTemplate="{StaticResource PlayingDataGridFirstColumnCellTemplate}" />
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Grid>
                        </Border>
                    </Popup>
                </StackPanel>
            </Viewbox>
        </Grid>
    </Grid>
</UserControl>
